<h3 class="page-title">Solver<span ng-show="synthNameForDisplay()"><small> [{{synthNameForDisplay()}}]</small></span></h3>
<div class="row-fluid class-selector-group">
  <div class="class-selector-group-left">
    <div class="btn-group">
      <button class="btn btn-primary"
              ng-model="recipe.cls"
              btn-radio="class"
              ng-repeat="class in splitClasses[0]"
              tooltip="{{class}}"
              tooltip-class="class-selector"
              tooltip-placement="top"
              tooltip-popup-delay="200">
        <img ng-src="img/classes/{{class}}.png"/>
      </button>
    </div>
  </div>
  <div class="class-selector-group-right">
    <div class="btn-group">
      <button class="btn btn-primary"
              ng-model="recipe.cls"
              btn-radio="class"
              ng-repeat="class in splitClasses[1]"
              tooltip="{{class}}"
              tooltip-class="class-selector"
              tooltip-placement="top"
              tooltip-popup-delay="200">
        <img ng-src="img/classes/{{class}}.png"/>
      </button>
    </div>
  </div>
</div>
<div class="row-fluid">
  <div class="settings-buttons">
    <div class="dropdown">
      <button type="button" class="btn" ng-click="newSynth()">New</button>
      <button type="button" class="btn dropdown-toggle">Load <span class="caret"></span></button>
      <ul class="dropdown-menu" isolate-scrolling>
        <li ng-repeat="name in savedSynthNames | orderBy:'toString()'">
          <a ng-click="loadSynth(name)">{{name}}</a>
        </li>
      </ul>
    </div>
    <button type="button" class="btn" ng-click="saveSynth()" ng-disabled="!isSynthDirty() || settings.name == ''">Save</button>
    <div class="my-dropdown save-as-control">
      <button type="button" class="btn my-dropdown-toggle" ng-click="saveAsSetup()">Save As...</button>
      <div class="my-dropdown-menu">
        <input class="input-medium my-dropdown-focus" type="text" ng-model="settings.saveAsName"
               select-on-focus stop-click-propogation ng-keypress="saveAsKeyPress($event)"/>
      </div>
    </div>
    <div class="dropdown">
      <button type="button" class="btn dropdown-toggle">Delete <span class="caret"></span></button>
      <ul class="dropdown-menu" isolate-scrolling>
        <li ng-repeat="name in savedSynthNames | orderBy:'toString()'">
          <a ng-click="deleteSynth(name)">{{name}}</a>
        </li>
      </ul>
    </div>
    <div class="dropdown">
      <button type="button" class="btn dropdown-toggle">Rename <span class="caret"></span></button>
      <ul class="dropdown-menu" isolate-scrolling>
        <li ng-repeat="name in savedSynthNames | orderBy:'toString()'">
          <a ng-click="renameSynth(name)">{{name}}</a>
        </li>
      </ul>
    </div>
  </div>
</div>
<div class="row-fluid">
  <div class="span12 recipe-search-control">
    <span class="my-dropdown" id="recipe-menu-root">
      <div class="input-append">
        <span class="span3 uneditable-input my-dropdown-toggle">{{recipe.name}}</span>
        <div class="btn-group">
          <button class="btn my-dropdown-toggle"><span class="caret"></span></button>
          <button class="btn" ng-click="showAddRecipeModal()"><i class="fa fa-plus"></i></button>
        </div>
      </div>
      <div class="my-dropdown-menu">
        <input class="input-medium search my-dropdown-focus" type="text" name="name" ng-model="recipeSearch.text"
               placeholder="Search..." select-on-focus stop-click-propogation
               ng-keypress="onSearchKeyPress($event)" ng-keydown="onSearchKeyDown($event)"
               id="recipe-search-text"/>
        <ul class="recipe-menu-scrollable" isolate-scrolling>
          <li class="loading" ng-show="recipeSearch.loading"><i class="fa fa-spinner fa-spin"></i> Loading...</li>
          <li ng-hide="recipeSearch.loading"
              ng-repeat="r in recipeSearch.list | orderBy:recipeSearch.order"
              ng-class="{active: $index === recipeSearch.selected}"
              id="recipeSearchElement{{$index}}"
              ng-mouseover="recipeSearch.selected=$index"
              ng-click="recipeSelected(r.name)">
            <a ng-click="recipeSelected(r.name)">[{{r.level}}] {{r.name}}</a>
            <a ng-show="r.user" class="pull-right" ng-click="deleteUserRecipe(r.name)"><i class="fa fa-minus-circle"></i></a>
          </li>
        </ul>
      </div>
    </span>
  </div>
</div>
<h4>Sequence
  <simulator-status class="initial-guess" recipe="recipe" status="simulatorStatus" valid="isValidSequence(simulatorStatus.sequence, recipe.cls)"></simulator-status>
</h4>
<div class="well" ng-class="{'edit-mode': editingSequence}">
  <div class="row-fluid">
    <div class="span9">
      <div class="sequence-editor" ng-show="editingSequence" ng-controller="SequenceEditorCtrl">
        <div class="sequence well well-small">
          <img ng-repeat="action in sequence track by $index"
               class="action selectable-action"
               ng-class="actionClasses(action, recipe.cls)"
               ng-src="{{getActionImagePath(action, recipe.cls)}}"
               ng-click="removeAction($index)"
               lvl-draggable="true"
               lvl-drop-target="true"
               data-index="{{$index}}"
               on-drop="dropAction(dragEl, dropEl)"/>

          <img class="action empty-action" lvl-drop-target="true"
               src="img/actions/empty.png"
               data-index="{{sequence.length}}"
               on-drop="dropAction(dragEl, dropEl)"/>
        </div>
        <div class="control-group">
          <button class="btn" ng-click="cancel()">Cancel</button>
          <button class="btn btn-primary" ng-disabled="!isSequenceDirty()" ng-click="save()">Save</button>
          <button class="btn btn-warning" ng-disabled="!isSequenceDirty()" ng-click="revert()">Revert</button>
          <button class="btn btn-warning" ng-disabled="sequence.length == 0" ng-click="clear()">Clear</button>
        </div>
        <div ng-show="uniqueCrossClassActions(sequence, recipe.cls).length > 0">
          <h5>Required Cross Class Actions</h5>
          <div class="sequence well well-small">
            <img ng-repeat="action in uniqueCrossClassActions(sequence, recipe.cls) track by $index"
                 class="action"
                 ng-src="{{getActionImagePath(action, recipe.cls)}}"
                 tooltip-html-unsafe="{{actionTooltip(action, recipe.cls)}}"
                 tooltip-placement="right"
                 tooltip-popup-delay="200"
                 tooltip-append-to-body="true"/>
          </div>
        </div>
        <h5>Available Actions</h5>
        <div class="action-table">
          <div class="action-group" ng-repeat="actionGroup in actionGroups">
            <label class="action-group-label">{{actionGroup.name}}</label>
            <div class="action-group-actions">
              <img ng-repeat="action in actionGroup.actions track by $index"
                   class="action selectable-action"
                   ng-class="actionClasses(action, recipe.cls)"
                   ng-show="isActionSelected(action)"
                   ng-src="{{getActionImagePath(action, recipe.cls)}}"
                   ng-click="addAction(action)"
                   tooltip-html-unsafe="{{sequenceActionTooltip(action, recipe.cls)}}"
                   tooltip-placement="right"
                   tooltip-popup-delay="200"
                   lvl-draggable="true"
                   data-new-action="{{action}}"/>
            </div>
          </div>
        </div>
      </div>
      <div ng-show="!editingSequence">
        <div class="sequence well well-small">
          <img ng-repeat="action in sequence track by $index"
               class="action"
               ng-class="actionClasses(action, recipe.cls)"
               ng-src="{{getActionImagePath(action, recipe.cls)}}"
               tooltip-html-unsafe="{{sequenceActionTooltip(action, recipe.cls)}}"
               tooltip-placement="right"
               tooltip-popup-delay="200"
               tooltip-append-to-body="true"/>
        </div>
        <div class="control-group">
          <button class="btn btn-primary" ng-click="editSequenceInline()" ng-disabled="simulatorStatus.running">Edit...</button>
          <button class="btn btn-primary" ng-click="showMacroModal()" ng-disabled="sequence.length == 0">Macro...</button>
          <button class="btn btn-primary" ng-click="runSimulation()" ng-disabled="simulatorStatus.running || !allForms.$valid || !isValidSequence(sequence, recipe.cls)">Simulate</button>
          <button class="btn btn-warning"
                  ng-disabled="!solverResult.sequence || solverResult.sequence.length == 0 || solverResult.sequence.equals(sequence)"
                  ng-click="useSolverResult()">Use Solver Result
          </button>
        </div>
        <div ng-show="uniqueCrossClassActions(sequence, recipe.cls).length > 0">
          <h5>Required Cross Class Actions</h5>
          <div class="sequence well well-small">
            <img ng-repeat="action in uniqueCrossClassActions(sequence, recipe.cls) track by $index"
                 class="action"
                 ng-src="{{getActionImagePath(action, recipe.cls)}}"
                 tooltip-html-unsafe="{{actionTooltip(action, recipe.cls)}}"
                 tooltip-placement="right"
                 tooltip-popup-delay="200"
                 tooltip-append-to-body="true"/>
          </div>
        </div>
      </div>
    </div>
    <div class="span3">
      <div class="well">
        <h5>{{recipe.cls}} Stats</h5>
        <ul>
          <li>Level: {{crafter.stats[recipe.cls].level}}</li>
          <li>Craftsmanship: {{crafter.stats[recipe.cls].craftsmanship}} + {{bonusStats.craftsmanship}}</li>
          <li>Control: {{crafter.stats[recipe.cls].control}} + {{bonusStats.control}}</li>
          <li>CP: {{crafter.stats[recipe.cls].cp}} + {{bonusStats.cp}}</li>
        </ul>
        <p><button class="btn" ng-click="showStatBonusesModal()">Stat Bonuses...</button></p>
      </div>
    </div>
  </div>
</div>
<div class="row-fluid">
  <h4>Solver Result
    <simulator-status class="solver-status" recipe="recipe" status="solverStatus" valid="isValidSequence(sequence, recipe.cls)"></simulator-status>
  </h4>
  <div class="control-group">
    <button class="btn btn-primary" ng-click="startSolver()" ng-show="solverStatus.generationsCompleted == 0 && !solverStatus.running" ng-disabled="!allForms.$valid || editingSequence || !isValidSequence(sequence, recipe.cls)">Start/Stop Solver</button>
    <button class="btn btn-primary" ng-click="stopSolver()" ng-show="solverStatus.running" ng-disabled="editingSequence">Start/Stop Solver</button>
    <button class="btn btn-primary" ng-click="resumeSolver()" ng-show="solverStatus.state && !solverStatus.running" ng-disabled="!allForms.$valid || editingSequence || !isValidSequence(sequence, recipe.cls) || solverStatus.error">Start/Stop Solver</button>
    <button class="btn btn-danger" ng-click="resetSolver()" ng-disabled="!allForms.$valid || !isValidSequence(sequence, recipe.cls) || editingSequence || !(solverStatus.state && !solverStatus.running)">Reset Solver</button>
  </div>
  <div class="sequence well well-small">
    <div ng-show="solverStatus.running">
      <progressbar class="progress-striped active"
                   value="solverStatus.generationsCompleted/solverStatus.maxGenerations*100">
        {{solverStatus.generationsCompleted}}/{{solverStatus.maxGenerations}}
      </progressbar>
    </div>
    <div ng-show="!solverStatus.running">
      <div ng-class="{'disabled-action-list': solverResult.sequence.equals(sequence)}">
        <img ng-repeat="action in solverResult.sequence track by $index"
             class="action"
             ng-class="actionClasses(action, recipe.cls)"
             ng-src="{{getActionImagePath(action, recipe.cls)}}"
             tooltip-html-unsafe="{{actionTooltip(action, recipe.cls)}}"
             tooltip-placement="top"
             tooltip-popup-delay="200"
             tooltip-append-to-body="true"/>
      </div>
    </div>
  </div>
  <tabset>
    <tab heading="Simulation Log" active="simulatorTabs.simulation.active">
      <pre>{{simulatorStatus.logText}}</pre>
    </tab>
    <tab heading="Solver Log" active="simulatorTabs.solver.active">
      <pre>{{solverResult.logText}}</pre>
    </tab>
  </tabset>
</div>
